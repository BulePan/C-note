# TCP粘包与分包
## 粘包
### 粘包现象
指发送方发送的若干数据到接收方时粘成一个包，从接收缓冲区看，后一包数据的头紧接着前一包数据的尾。

### 出现粘包原因
1. 发送方原因，TCP默认使用Nagle算法，将多次间隔小、数据量小的数据合并成一个大的数据块，然后封包发送。
2. 接收方原因，TCP接到分组时，应用层并不一定会立即处理，这样一来，如果TCP接收分组的速度大于应用程序处理分组的速度，多个包就会被缓存，应用程序读时，就会读到多个首尾相接粘到一起的包。

## 分包 
+ **断连接**：对于短连接的TCP服务，分包不是问题，只要发送方主动关闭连接，就表示一条消息发送完毕，接收方`read`返回0，从而知道消息的结尾。比如daytime服务。
+ **长连接**
    1. 消息长度固定；
    2. 使用特殊的字符或字符串作为消息边界；
    3. 在每条消息头部加一个长度字段；
    4. 利用消息本身的格式来分包，例如XML格式的消息中`<root>...</root>`的配对，JSON格式中的`{...}`的配对，解析这种消息格式通常会用到状态机。
