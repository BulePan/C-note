# TCP连接的建立与终止

##连接建立(三路握手)
1. 服务器必须转备好接收外来的连接，这通常通过调用`socket`、`bind`和`listen`这3个函数来完成，常称之为**被动打开**。
2. 客户通过调用`connect`发起**主动打开**。这导致客户TCP发送一个SYN(同步)分节，它告诉服务器客户将在(待建立的)连接中发送的数据的初始序列号。通常SYN分节不携带数据，其所在IP数据报只包含由一个IP首部、一个TCP首部及可能有的TCP选项。
3. 服务器必须确认(ACK)客户的SYN， 同时自己也的发送一个SYN分节，它含有服务器将在同一连接中发送的数据的初始化序列号。服务器在单个分节中发送SYN和对客户的ACK。
4. 客户必须确认服务器的SYN。
这种交换至少需要3个分组，因此称之为TCP的三路握手，下图展示了所交换的3个分节。
![](/home/pan/C++/imgs/TCP三路握手.png)

**TCP选项**：每个SYN可以包含多个TCP选项，常用的TCP选项如下

+ **MSS选项**：发送SYN的TCP一端使用本选项通告对端它的最大分节大小(maximum segment size)即MSS，也就是它在本连接的每个TCP分节中愿意接收的最大数据量。发送端TCP使用接收端的MSS值作为所发送分节的最大大小。
+ **窗口规模选项**：TCP连接任何一端能够告知对端的最大窗口大小是65535，因为在TCP首部中相应的字段占16位，然而当今因特网上业已普及的高速网络连接或长延迟路径(卫星链路)要求有更大的窗口以获得尽可能大的吞吐量。这个新选项指定TCP首部中的通告串口必须扩大(左移)的位数(0~14),因此所提供的最大窗口接近1GB(65535×2~14)。在一个TCP连接上使用窗口规模的前提是它的两个端系统必须都支持这个选项。
+ **时间戳选项**：这个选项对于高速网络连接是必须的，他可以防止由失而复得的分组可能造成的数据损坏。
==后两个选项有时称**RFC 1323选项**，因为在RFC1323中说明，既然高速宽带或长延迟的网络被称为**长胖管道**，这两个选项也称为**长胖管道选项。**==

## TCP连接终止(四路挥手)
1. 某个应用进程首先调用`close`，这称该端执行**主动关闭**。该端的TCP于是发送一个FIN分节，表示数据发送完毕。
2. 接收到这个FIN的对端执行**被动关闭**，这个FIN由TCP确认，它的接收也为一个文件结束符传递给接收端应用进程(放在任何其他数据之后)，因为FIN的接收意味着接收端应用进程在相应连接上在无额外数据可接收。
3. 一段时间后，接收到这个文件结束符的应用进程调用`close`关闭它的套接字，这导致它的TCP也发送一个FIN。
4. 接收这个最终FIN的原发送端TCP(执行主动关闭的那一端)确认这个FIN。
每个方向都需要一个FIN和一个ACK，一次通常需要4个分节。下图展示了所需的4个分节。
![](/home/pan/C++/imgs/TCP四次挥手.png)

## TCP状态转换图
TCP涉及连接建立和连接终止的操作可以用**状态转换图**来说明，如下图所示。
TCP为一个连接定义了11种状态，并且TCP规则规定如何基于当前状态及在该状态下所接收的分节从一个状态转换到另一个状态。

+ CLOSED：这个状态不是一个真正的状态，是图中假象的一个起点或终点。
+ LISTEN：服务器等待连接的状态。
+ SYN_SEND：客户端发起连接(主动打开)变成此状态，如果SYN超时或者服务器不存在直接CLOSED。
+ SYN_RCVD：服务器收到SYN包时就变成此状态。
+ ESTABLISHED：完成三次握手，进入连接建立状态，说明此时可以进行数据传输了。
+ FIN_WAIT_1：客户端执行主动关闭，发送完FIN包后便进入FIN_WAIT_1状态
+ FIN_WAIT_2：客户端发送FIN包之后，收到ACK，即进入此状态，其实就是半关闭状态。
+ TIME_WAIT：从图上看，有三种情况，从FIN_WAIT_2进入，客户端收到服务器发送过来的FIN包之后进入TIME_WAIT状态；由CLOSING状态进入，这是同时关闭的状态，同时发起FIN请求，同时接收并做了ACK的回复；从FIN_WAIT_1进入，收到对端的FIN,ACK,并回复ACK。
+ CLOSE_WAIT：接收到FIN后，被动的一方进入此状态，并回复ACK。
+ CLOSING：两边同时发出FIN请求。
![](/home/pan/C++/imgs/状态转换图.png) 

### TIME_WAIT状态
上图中看到执行主动关闭的那端经历了这个状态。该端点停留在这个状态的持续时间是最大分节生命期(maximum segment lifetime，**MSL**)的两倍，及**2MSL**，MSL的值一般在30秒-2分钟。
TIME_WAIT状态存在的两个理由：
1. 可靠的实现TCP的全双工连接的终止；
2. 允许老的重复分节在网络中消逝。
第一个理由假设断开连接的最后一个ACK丢失来解释。服务器将重复发送它最终的那个FIN，因此客户必须维护状态信息，以允许它重新发送最终那个ACK。要是客户不维护状态信息，它将响应一个RST分节，该分节将被服务器解释成一个错误。如果TCP打算执行所有必要的工作以彻底终止某个连接上的全双工数据流，那个它必须正确处理连接终止序列4个分节中任意一个丢失的情况。
第二个理由，能保证每成功建立一个TCP连接时，来自该连接先前的化身的老的重复分组都已在网络中消逝。



